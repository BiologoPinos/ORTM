---
title: "PISCO_kelp_urchin_swath.Rmd"
author: "Andrés Pinos-Sánchez"
date: "2025-05-15"
output: 
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
library(ggplot2)
library(dplyr)
library(readr)
library(tidyverse)
library(ggpubr)

#Clear
rm(list = ls()) #environment

set.seed(123)

setwd("C:/Users/pinosa/Documents/Git/OR_trophic_model/Code/Data_DataExploration/PISCO_kelp_urchin_swath_data")
```

## Aim of this script
Obtain measures of mean and variability of bull kelp, and urchins densities in Oregon


#### GETTING THE DATA

This data is from PISCO surveys posted by Mark H Carr, Jennifer E Caselle, and Daniel P Malone
for kelp forest monitoring
O.G. data: https://data.piscoweb.org/metacatui/view/doi%3A10.6085%2FAA%2FPISCO_kelpforest.1.10
```{r}
# Read in taxon table
KelpForest_Taxon <- read_csv("PISCO_kelpforest_taxon_table.1.3.csv")

# read in sites table
KelpForest_Sites <- read_csv("PISCO_kelpforest_site_table.1.3.csv")

# read in Swath data
KelpForest_Swath <- read_csv("PISCO_kelpforest_swath.1.3.csv")

# read in Quad data
KelpForest_Quad <- read_csv("PISCO_kelpforest_quad.1.3.csv")

# read in fish data
KelpForest_Fish <- read_csv("PISCO_kelpforest_fish.1.4.csv")
```

Modify data (Only relevant for MPA status - Not being used in OR model)
```{r}
# add site_status to data
site_status <- KelpForest_Sites %>% select(site, site_status) %>% unique() 

KelpForest_Swath <- left_join(KelpForest_Swath, site_status, by = "site")

KelpForest_Quad <- left_join(KelpForest_Quad, site_status, by = "site")
```


#### BULL KELP ADULTS

Pull out swath (KelpForest_Swath) data for adult bull kelp
```{r}
# filter for Bull kelp (Nereocystis luetkeana = NERLUE)
KFSwatch_Kelp <- KelpForest_Swath %>% filter(classcode == "NERLUE")

# deal with NAs for size and count (number of individual = number of stipes)
# no other info given, so will assume = 1
KFSwatch_Kelp <- KFSwatch_Kelp %>% replace_na(list(size = 1, count = 1))

# cut out non-essential columns
KFSwatch_Kelp <- KFSwatch_Kelp %>% select(year:size,site_status)

# Get stipe density (number of stipes)
KFSwatch_Kelp <- KFSwatch_Kelp %>%
  mutate(Kelp_plants = count,
         Kelp_stipes = count*size) 

# sum within year, site, zone, and transect
KFSwatch_Kelp <- KFSwatch_Kelp %>%
  group_by(year, site, zone, transect) %>% 
  summarise(Kelp_plants = sum(Kelp_plants),
         Kelp_stipes = sum(Kelp_stipes))
```

Assuming that adult bull kelp are 10 meters tall (Lenght of stipe), and using 
the following regression (Stekol, l et al., 2007) Wet Plant Weight = 0.0346e^(0.501*X)
where X = Lenght of stipe (m), then Wet Biomass of Bull kelp using syipe lenght of 10m is 5.18kg/stipe
```{r}
# kelp wet biomass is ~1.06kg per plant (stipe)
KFSwatch_Kelp <- KFSwatch_Kelp %>% 
  mutate(Kelp_biomasswet = 5.18*Kelp_stipes)
```

Focusing on Oregon coast
```{r}
# list of sites for OR
KelpForest_Sites %>% filter(latitude >= 42.6673) %>% pull(site) %>% unique()

# filter and separate for OR
Kelp_df_OR <- KFSwatch_Kelp %>% rowwise() %>% 
  filter(site %in% c("GOVERNMENT_POINT", "GULL_ROCK_CEN", "GULL_ROCK_DC",
                     "GULL_ROCK_UC", "HUMBUG_CLIFF_N", "HUMBUG_CLIFF_S",
                     "ISLAND_ROCK", "MCKENZIE_W", "NELLIE'S_COVE",
                     "OTTER_CREST", "OTTER_CREST_DC", "OTTER_ROCK_KELP_E",
                     "OTTER_ROCK_WALL_E", "REDFISH_ROCKS_KELP_N", "REDFISH_ROCKS_KELP_S",
                     "REDFISH_ROCKS_MAMADOME_E", "REDFISH_ROCKS_TOWER_E", "REDFISH_ROCKS_TOWER_W",
                     "REDFISH_ROCKS_WHALEBACK_E", "REDFISH_ROCKS_WHALEBACK_W", "RED_FISH_ROCKS",
                     "SPOUTING_HORN_KELP", "SPOUTING_HORN_WALL", "WHALE_COVE_CONTROL_DC",
                     "WHALE_COVE_CONTROL_UC", "WHALE_COVE_RESERVE")) %>% 
  separate_wider_regex(site, c(site = ".*", "_", side = ".*"))
```

Scaling transition (spatial variance in kelp densities)
- Using Oregon sites
- calculate variance within sites and across years, then take the mean variance across years within sites, and then take the overall mean variance. 
```{r}
# Step 1: Variance of Kelp biomass per site per year
kelp_var_site_year <- Kelp_df_OR %>%
  group_by(site, year) %>%
  summarise(Kelp_biomasswet_var = var(Kelp_biomasswet), .groups = "drop")

# Step 2: Mean variance across years within each site
kelp_mean_var_per_site <- kelp_var_site_year %>%
  group_by(site) %>%
  summarise(mean_var = mean(Kelp_biomasswet_var, na.rm = TRUE), .groups = "drop")

# Step 3: Overall mean of site-level mean variances
overall_mean_var <- mean(kelp_mean_var_per_site$mean_var, na.rm = TRUE)

overall_mean_var
```

#### BULL KELP RECRUITS

Here we use swath (KelpForest_Swath) data for bull kelp recruits assuming that kelp
on month "8" (August) are successfully settle recruits
```{r}
# Step 1: Filter for bull kelp (all stages)
KFSwath_KRecruit <- KelpForest_Swath %>%
  filter(classcode == "NERLUE")

# Step 2: Keep relevant columns, including month
KFSwath_KRecruit <- KFSwath_KRecruit %>%
  select(year, month, site, zone, transect, count)

# Step 3: Group by site and transect across months to average within transects
KFSwath_KRecruit <- KFSwath_KRecruit %>%
  group_by(year, month, site, zone, transect) %>%
  summarise(Kelp_count = mean(count), .groups = "drop")

# Step 4: Filter for Central California sites
KelpR_df_OR <- KFSwath_KRecruit %>%
  filter(site %in% c("GOVERNMENT_POINT", "GULL_ROCK_CEN", "GULL_ROCK_DC",
                     "GULL_ROCK_UC", "HUMBUG_CLIFF_N", "HUMBUG_CLIFF_S",
                     "ISLAND_ROCK", "MCKENZIE_W", "NELLIE'S_COVE",
                     "OTTER_CREST", "OTTER_CREST_DC", "OTTER_ROCK_KELP_E",
                     "OTTER_ROCK_WALL_E", "REDFISH_ROCKS_KELP_N", "REDFISH_ROCKS_KELP_S",
                     "REDFISH_ROCKS_MAMADOME_E", "REDFISH_ROCKS_TOWER_E", "REDFISH_ROCKS_TOWER_W",
                     "REDFISH_ROCKS_WHALEBACK_E", "REDFISH_ROCKS_WHALEBACK_W", "RED_FISH_ROCKS",
                     "SPOUTING_HORN_KELP", "SPOUTING_HORN_WALL", "WHALE_COVE_CONTROL_DC",
                     "WHALE_COVE_CONTROL_UC", "WHALE_COVE_RESERVE"))

# Step 5: Focus on August (month 8), "proxy" for recruitment success
KelpR_june <- KelpR_df_OR %>%
  filter(month == 8)

# Step 6: Get site-level means by year
KelpR_june_siteyr <- KelpR_june %>%
  group_by(year, site) %>%
  summarise(Kelp_mean = mean(Kelp_count), .groups = "drop")

# Step 7: Fit GLM to detrend site and year effects
model <- glm(Kelp_mean ~ year * site, data = KelpR_june_siteyr)

# Step 8: Reconstruct detrended time series
tsDT <- mean(KelpR_june_siteyr$Kelp_mean) + residuals(model)

# Step 9: Normalize and calculate standard deviation (temporal noise)
tsDT_norm <- tsDT / mean(tsDT)
temporal_noise <- sd(tsDT_norm)

temporal_noise
```


#### URCHINS ADULTS

Pull out data for urchins
```{r}
# Step 1: Filter and expand raw swath data for adult purple and red urchins:
# MESFRAAD = red, STRPURAD = purple (>2.5 cm test diameter)
Urchin_raw <- KelpForest_Swath %>%
  filter(classcode %in% c("MESFRAAD", "STRPURAD")) %>%
  filter(!is.na(size)) %>%
  uncount(weights = count) # replicate by count for proper size expansion

# Step 2: Summarise size distributions (optional exploratory step)
# Summary stats by species and year
Urchin_raw %>% 
  group_by(year, classcode) %>% 
  summarise(mean_size = mean(size), 
            median_size = median(size), 
            max_size = max(size), 
            min_size = min(size), 
            n = n())

# Overall species stats
Urchin_raw %>%
  group_by(classcode) %>%
  summarise(mean_size = mean(size), 
            median_size = median(size), 
            max_size = max(size), 
            min_size = min(size),
            n = n())

#Step 3: Set biomass conversion constants (Ling et al. 2015, Supp Table 1)
red_bio <- (0.0499 * 7 + 0.0019)     # average biomass for red urchins (~7 cm)
pur_bio <- (0.0499 * 4.1 + 0.0019)   # average biomass for purple urchins (~4.1 cm)

# Step 4: Filter, simplify, and clean urchin dataset for Oregon
# Select relevant columns
Urchins_OR <- KelpForest_Swath %>%
  filter(classcode %in% c("MESFRAAD", "STRPURAD")) %>%
  select(year:count, site_status)

# Filter for Oregon sites
Urchins_OR <- Urchins_OR %>%
  filter(site %in% c("GOVERNMENT_POINT", "GULL_ROCK_CEN", "GULL_ROCK_DC",
                     "GULL_ROCK_UC", "HUMBUG_CLIFF_N", "HUMBUG_CLIFF_S",
                     "ISLAND_ROCK", "MCKENZIE_W", "NELLIE'S_COVE",
                     "OTTER_CREST", "OTTER_CREST_DC", "OTTER_ROCK_KELP_E",
                     "OTTER_ROCK_WALL_E", "REDFISH_ROCKS_KELP_N", "REDFISH_ROCKS_KELP_S",
                     "REDFISH_ROCKS_MAMADOME_E", "REDFISH_ROCKS_TOWER_E", "REDFISH_ROCKS_TOWER_W",
                     "REDFISH_ROCKS_WHALEBACK_E", "REDFISH_ROCKS_WHALEBACK_W", "RED_FISH_ROCKS",
                     "SPOUTING_HORN_KELP", "SPOUTING_HORN_WALL", "WHALE_COVE_CONTROL_DC",
                     "WHALE_COVE_CONTROL_UC", "WHALE_COVE_RESERVE")) %>%
  separate_wider_regex(site, c(site = ".*", "_", side = ".*"))

# Step 5: Aggregate counts within each transect
Urchins_OR <- Urchins_OR %>%
  group_by(year, site, side, zone, classcode, transect, site_status) %>%
  summarise(count = sum(count), .groups = "drop")

# Step 6: Calculate species-level biomass and total counts per transect
Urchins_wide <- Urchins_OR %>%
  pivot_wider(names_from = classcode, values_from = count) %>%
  rename(red_count = MESFRAAD, purple_count = STRPURAD) %>%
  mutate(red_biomass = red_count * red_bio,
         purple_biomass = purple_count * pur_bio,
         Urchins_count = rowSums(across(c(red_count, purple_count)), na.rm = TRUE),
         Urchins_biomass = rowSums(across(c(red_biomass, purple_biomass)), na.rm = TRUE))
```

Scaling transition (Spatial Variance in Urchin Biomass)
- Estimate spatial variance in adult biomass within zones, summarised across years and species.
```{r}
# Step 1: Long format and variance by site-year-zone
Urchins_var_yr <- Urchins_wide %>%
  pivot_longer(cols = c(red_count:Urchins_biomass),
               names_to = c("spp", ".value"), 
               names_sep = "_") %>%
  group_by(year, site, side, zone, spp) %>%
  summarise(Urchin_biomass_var = var(biomass, na.rm = TRUE), .groups = "drop")

# Step 2: Average variance across transects by year (temporal component)
Urchin_bio_var_time <- Urchins_var_yr %>%
  group_by(year, spp) %>%
  summarise(Urchin_biomass_meanvar = mean(Urchin_biomass_var, na.rm = TRUE), .groups = "drop") %>%
  group_by(spp) %>%
  summarise(Urchin_biomass_yearvar = mean(Urchin_biomass_meanvar, na.rm = TRUE))

# Step 3: Overall mean variance across all years (space-time integrated)
Urchin_bio_var_overall <- Urchins_var_yr %>%
  group_by(spp) %>%
  summarise(Urchin_biomass_meanvar = mean(Urchin_biomass_var, na.rm = TRUE))

Urchin_bio_var_overall
```

#### Urchin recruits

Pull out data for urchin recruits
```{r}
# filter for recruits (<2.5cm test diameter) purple and red (MESFRAAD) urchins 
KFSwatch_UrchinREC <- KelpForest_Swath %>% filter(classcode %in% c("MESFRAREC", "STRPURREC"))

# cut out non-essential columns
KFSwatch_UrchinREC <- KFSwatch_UrchinREC %>% select(year:count, site_status) 

# Sum within transects
KFSwatch_UrchinREC <- KFSwatch_UrchinREC %>%
  group_by(year, site, zone, classcode, transect, site_status) %>%
  summarise(count = sum(count))


# Calc year-to-year mean/stdev across all transects
KFSwatch_UrchinRECyr <- KFSwatch_UrchinREC %>% 
  group_by(year) %>% 
  summarise(across(count, list(mean = mean, sd = sd)))


# plot
ggplot(KFSwatch_UrchinREC %>% group_by(site, year) %>% 
      summarise(across(count, list(mean = mean)))) +
  geom_line(aes(y = count_mean, x = year, color = site )) +
  theme(legend.position="none") +
  geom_line(data = KFSwatch_UrchinRECyr,
            aes(y = count_mean, x = year), size = 1) +
  theme(legend.position="none")


#calc yr2yr var ----
KFSwatch_UrchinRECyr %>% 
  ungroup %>% 
  summarise(across(count_mean:count_sd, list(mean = mean, sd = sd)))


# detrend:
    # fit linear model
    Model <- glm(KFSwatch_UrchinRECyr$count_mean ~ KFSwatch_UrchinRECyr$year)
    
    # mean plus residuals
    tsDT <- mean(KFSwatch_UrchinRECyr$count_mean) + Model$residuals
    
    # make dataframe
    Model_df <- tibble(year = KFSwatch_UrchinRECyr$year, tsDT)
    
    ggplot(Model_df) + 
      geom_line(aes(y = tsDT, x = year))

# normalise and get varaince
    tsDTnorm <- tsDT/mean(tsDT)   
    
    sd(tsDTnorm)

```


<!-- ### Urchin-Kelp -->

<!-- Join tables -->
<!-- ```{r} -->
<!-- KelpUrchin_df <- Kelp_df %>%  -->
<!--   full_join(Urchins_df_OR, -->
<!--             by = c("year","site", "side", "zone", "transect", "site_status"))  -->

<!-- # replace NA with 0 -->
<!-- KelpUrchin_df <- KelpUrchin_df %>% replace(is.na(.), 0) -->

<!-- # set site status  -->
<!-- KelpUrchin_df <- KelpUrchin_df %>%  -->
<!--   mutate(site_status = as.factor(site_status)) -->

<!-- # remove sites with <3 years of data -->
<!--   # find sites with >3 years -->
<!--   site_keep <- KelpUrchin_df %>%  -->
<!--     select(site, year) %>%  -->
<!--     unique() %>%  -->
<!--     group_by(site) %>%  -->
<!--     filter(n()>2) %>% pull(site) -->

<!--   KelpUrchin_df <- KelpUrchin_df %>%  -->
<!--     filter(site %in% site_keep) -->


<!-- # calc stats at site level -->
<!-- KelpUrchin_df_site <- KelpUrchin_df %>%  -->
<!--   group_by(year, site, site_status) %>%  -->
<!--   summarise(across(Kelp_plants:Urchins_biomass, ~mean(., na.rm = T))) -->

<!-- # take log -->
<!-- KelpUrchin_df_site <- KelpUrchin_df_site %>%  -->
<!--   mutate(across(Kelp_plants:Urchins_biomass, ~log(.), .names = "{col}_ln")) -->



<!-- ``` -->


<!-- Transect scale -->

<!-- urchins v. kelp -->
<!-- ```{r} -->
<!-- # basic -->
<!-- ggplot(KelpUrchin_df) + -->
<!--   geom_point(aes(x = Urchins_biomass, y = Kelp_biomasswet), alpha = 0.3) + -->
<!--   ylab('Kelp (kg/60m2)') + xlab('Urchins (kg/60m2)') -->


<!-- # facet MPA status -->
<!-- ggplot(KelpUrchin_df, aes(x = Urchins_biomass, y = Kelp_biomasswet, color = site_status)) + -->
<!--   geom_point(alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1, scales = 'free') +  -->
<!--   geom_rug(linewidth=0.1) + -->
<!--   ylab('Kelp (kg/60m2)') + xlab('Urchins (kg/60m2)') -->

<!-- ggscatterhist( -->
<!--   KelpUrchin_df, x = "Urchins_biomass", y = "Kelp_biomasswet", -->
<!--   color = "site_status", fill = "site_status", -->
<!--   size = 3, alpha = 0.6, -->
<!--   margin.plot = "boxplot", -->
<!--   ggtheme = theme_bw()) -->



<!-- # facet site (+MPA status) -->
<!-- ggplot(KelpUrchin_df, aes(x = Urchins_biomass, y = Kelp_biomasswet, color = site_status)) + -->
<!--   geom_point(alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status, site)) +  -->
<!--   geom_rug(linewidth=0.1) + -->
<!--   ylab('Kelp (kg/60m2)') + xlab('Urchins (kg/60m2)') -->



<!-- # facet MPA status + colour urchin -->
<!-- ggplot(KelpUrchin_df) + -->
<!--   geom_point(aes(x = purple_biomass, y = Kelp_biomasswet), colour = "purple", alpha = 0.3) + -->
<!--   geom_point(aes(x = red_biomass, y = Kelp_biomasswet), colour = "red", alpha = 0.3) + -->
<!--     facet_wrap(vars(site_status), ncol = 1, scales = 'free') + -->
<!--   ylab('Kelp (kg/60m2)') + xlab('Urchins (kg/60m2)') -->


<!-- ggplot(KelpUrchin_df) + -->
<!--   geom_point(aes(x = purple_count, y = Kelp_stipes), colour = "purple", alpha = 0.3) + -->
<!--   geom_point(aes(x = red_count, y = Kelp_stipes), colour = "red", alpha = 0.3) + -->
<!--     facet_wrap(vars(site_status), ncol = 1, scales = 'free') + -->
<!--   ylab('Stipes (no./60m2)') + xlab('Urchins (no./60m2)') -->

<!-- ``` -->

<!-- urchins & kelp data distributions -->
<!-- ```{r} -->
<!-- g1 <- ggplot(KelpUrchin_df) + -->
<!--   stat_ecdf(aes(x = Kelp_biomasswet, colour = site_status),  -->
<!--             size = 1, pad = F) -->

<!-- g2 <- ggplot(KelpUrchin_df) + -->
<!--   stat_ecdf(aes(x = -Urchins_biomass, colour = site_status), -->
<!--             size = 1, pad = F) -->

<!-- ggarrange(g1, g2, ncol = 1) -->

<!-- ``` -->

<!-- urchins & kelp v. time -->
<!-- ```{r} -->
<!-- ggplot(KelpUrchin_df) + -->
<!--   geom_point(aes(y = Urchins_biomass, x = year), colour = "orange", alpha = 0.3) + -->
<!--   geom_point(aes(y = Kelp_biomasswet, x = year), colour = "darkgreen", alpha = 0.3)  -->

<!-- ggplot(KelpUrchin_df, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = Urchins_biomass), colour = "orange", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Urchins_biomass), colour = "orange", alpha = 0.3) + -->
<!--   geom_hline(yintercept = 204, linetype = "dashed", color = "grey80", size = 1) + # ling threshold upper -->
<!--   geom_hline(yintercept = 156, linetype = "dashed", color = "grey50", size = 1) + # ling threshold mean -->
<!--   geom_hline(yintercept = 108, linetype = "dashed", color = "grey80", size = 1) + # ling threshold lower -->
<!--   geom_vline(xintercept = 2014, linetype = "dashed", color = "red", size = 1) + # heatwave -->
<!--   geom_vline(xintercept = 2016, linetype = "dashed", color = "red", size = 1) + -->
<!--   facet_wrap(vars(site_status, site)) + -->
<!--   scale_y_continuous(name = "biomass (kg/60m2)", limit = c(0,1000)) + -->
<!--   theme_bw() -->

<!-- # Anacapa East over-time averages (first by year, than over) -->
<!-- KelpUrchin_df %>%  -->
<!--   filter(site == "ANACAPA_EAST_ISLE") %>%  -->
<!--   group_by(year) %>%  -->
<!--   summarise(across(Kelp_plants:Urchins_biomass, ~mean(.))) %>%  -->
<!--   summarise(across(Kelp_plants:Urchins_biomass, ~mean(.))) -->


<!-- ggplot(KelpUrchin_df, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = Urchins_count), colour = "orange", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Urchins_count), colour = "orange", alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status, site)) + -->
<!--   scale_y_continuous(name = "Abundance (no./60m2)") -->


<!-- ggplot(KelpUrchin_df) + -->
<!--   geom_point(aes(y = Kelp_biomasswet, x = year), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = purple_biomass, x = year), colour = "purple", alpha = 0.3) + -->
<!--   geom_point(aes(y = red_biomass, x = year), colour = "red", alpha = 0.3) +   -->
<!--   facet_wrap(~site) -->


<!-- ``` -->


<!-- Site scale -->
<!-- ```{r} -->
<!-- # mean and sd across sites -->
<!-- KelpUrchin_df_site %>% ungroup() %>%  -->
<!--   summarise(across(c(Kelp_biomasswet,Urchins_biomass), list(mean = mean, sd = sd))) -->

<!-- # mean and sd across forested sites only -->
<!-- KelpUrchin_df_site %>% ungroup() %>%  -->
<!--   filter(Kelp_biomasswet>0) %>%  -->
<!--   summarise(across(c(Kelp_biomasswet,Urchins_biomass), list(mean = mean, sd = sd))) -->

<!-- # mean and sd across sites by status -->
<!-- KelpUrchin_df_site %>% group_by(site_status) %>%  -->
<!--   summarise(across(c(Kelp_biomasswet,Urchins_biomass), list(mean = mean, sd = sd))) -->


<!-- ggscatterhist( -->
<!--   KelpUrchin_df_site, x = "Urchins_biomass", y = "Kelp_biomasswet", -->
<!--   color = "site_status", fill = "site_status", -->
<!--   size = 3, alpha = 0.6, -->
<!--   margin.plot = "boxplot", ggtheme = theme_bw(),  -->
<!--   xlab = 'Observed urchin biomass (kg.60m2)', ylab = 'Observed kelp biomass (kg.60m2)') -->


<!-- # (per m2) -->
<!--  KelpUrchin_df_site <- KelpUrchin_df_site %>%  -->
<!--             mutate(Urchins_biomass_m = Urchins_biomass/60,  -->
<!--                    Kelp_biomasswet_m = Kelp_biomasswet/60) -->
<!-- ggscatterhist( -->
<!--   KelpUrchin_df_site, x = "Urchins_biomass_m", y = "Kelp_biomasswet_m", -->
<!--   size = 3, alpha = 0.6, -->
<!--   margin.plot = "boxplot", -->
<!--   ggtheme = theme_bw()) -->



<!-- ggplot(KelpUrchin_df_site, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = Urchins_biomass), colour = "orange", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Urchins_biomass), colour = "orange", alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   geom_hline(yintercept = (2.6+0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold upper -->
<!--   geom_hline(yintercept = 2.6*60, linetype = "dashed", color = "grey50", size = 1) + # ling threshold mean -->
<!--   geom_hline(yintercept = (2.6-0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold lower   -->
<!--   geom_vline(xintercept = 2014, linetype = "dashed", color = "red", size = 1) + # heatwave -->
<!--   geom_vline(xintercept = 2016, linetype = "dashed", color = "red", size = 1) + -->
<!--   scale_y_continuous(name = "biomass (kg/60m2)") + -->
<!--   theme_bw() -->



<!-- KelpUrchin_df_sitemeanMPA <- KelpUrchin_df_site %>%  -->
<!--   group_by(site_status, year) %>%  -->
<!--   summarise(across(Kelp_plants:Urchins_biomass, ~mean(.)))  -->

<!-- ggplot(KelpUrchin_df_sitemeanMPA,aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_biomasswet), colour = "darkgreen", size = 2) + -->
<!--   geom_point(aes(y = Urchins_biomass), colour = "orange", size = 2) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   geom_hline(yintercept = (2.6+0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold upper -->
<!--   geom_hline(yintercept = 2.6*60, linetype = "dashed", color = "grey50", size = 1) + # ling threshold mean -->
<!--   geom_hline(yintercept = (2.6-0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold lower   -->
<!--   geom_vline(xintercept = 2014, linetype = "dashed", color = "red", size = 1) + # heatwave -->
<!--   geom_vline(xintercept = 2016, linetype = "dashed", color = "red", size = 1) + -->
<!--   scale_y_continuous(name = "biomass (kg/60m2)") + -->
<!--   theme_bw() -->

<!-- ggplot(KelpUrchin_df_sitemeanMPA) + -->
<!--   geom_point(aes(y = Kelp_biomasswet, x = Urchins_biomass, colour = site_status), size = 2) + -->
<!--   geom_point(data = KelpUrchin_df_site, aes(y = Kelp_biomasswet, x = Urchins_biomass, colour = site_status), alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   geom_vline(xintercept = (2.6+0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold upper -->
<!--   geom_vline(xintercept = 2.6*60, linetype = "dashed", color = "grey50", size = 1) + # ling threshold mean -->
<!--   geom_vline(xintercept = (2.6-0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold lower   -->
<!--   scale_y_continuous(name = "biomass (kg/60m2)") + -->
<!--   theme_bw() -->





<!-- ggplot(KelpUrchin_df_site, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = purple_biomass), colour = "purple", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = purple_biomass), colour = "purple", alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   scale_y_continuous(name = "biomass (kg/60m2)") + -->
<!--   theme_bw() -->



<!-- ggplot(KelpUrchin_df_site, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = Urchins_count), colour = "orange", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Urchins_count), colour = "orange", alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   scale_y_continuous(name = "density (no./60m2)",  limits = c(0,300)) + -->
<!--   theme_bw() -->


<!-- ggplot(KelpUrchin_df_site, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = purple_count), colour = "purple", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = purple_count), colour = "purple", alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   scale_y_continuous(name = "density (no./60m2)",  limits = c(0,300)) + -->
<!--   theme_bw() -->

<!-- ``` -->
