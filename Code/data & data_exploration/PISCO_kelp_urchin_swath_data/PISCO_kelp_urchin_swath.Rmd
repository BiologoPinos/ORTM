---
title: "PISCO_kelp_urchin_swath.Rmd"
author: "Andrés Pinos-Sánchez"
date: "2025-05-15"
output: 
  html_document: default
  pdf_document: default
---

#### AIM OF CODE
Obtain mean and variability metrics for bull kelp and urchin densities along the Oregon coast.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 

# Load libraries
library(ggplot2)
library(dplyr)
library(readr)
library(tidyverse)
library(ggpubr)
library(brms)
library(posterior)

# Clear workspace and set seed
rm(list = ls()) #environment
set.seed(123)

# Working directory
setwd("C:/Users/pinosa/Documents/Git/OR_trophic_model/Code/Data_DataExploration/PISCO_kelp_urchin_swath_data")

```

#### GETTING THE DATA

This data is from PISCO surveys posted by Mark H Carr, Jennifer E Caselle, and Daniel P Malone
for kelp forest monitoring
O.G. data: https://data.piscoweb.org/metacatui/view/doi%3A10.6085%2FAA%2FPISCO_kelpforest.1.10
```{r}
# Read PISCO data
taxon <- read_csv("PISCO_kelpforest_taxon_table.1.3.csv") #taxon table
sites <- read_csv("PISCO_kelpforest_site_table.1.3.csv") #sites table
swath <- read_csv("PISCO_kelpforest_swath.1.3.csv") #Swath data
quad  <- read_csv("PISCO_kelpforest_quad.1.3.csv") #Quad data
fish  <- read_csv("PISCO_kelpforest_fish.1.4.csv") #fish data

```

Annotate MPA status (only relevant for CA model)
```{r}
site_status <- sites %>% select(site, site_status) %>% distinct()
swath <- left_join(swath, site_status, by = "site")
quad  <- left_join(quad,  site_status, by = "site")

```


#### BULL KELP ADULTS
Determine: Scaling transition (spatial variance in kelp densities)
```{r}
# Step 1: Filter for Bull kelp (N.luetkeana = NERLUE), and group transects across time & space
kelp_adult <- swath %>%
  filter(classcode == "NERLUE") %>% # 
  replace_na(list(size = 1, count = 1)) %>% # assume missing = 1
  transmute(year, site, zone, transect,
            plants = count,
            stipes = count * size) %>%
  group_by(year, site, zone, transect) %>%
  summarise(plants   = sum(plants),
            stipes   = sum(stipes),
            biomass  = stipes * 5.18,  # 5.18kg per stipe
            .groups = "drop")

# Step 2: Filter Oregon sites (lat ≥42.6673)
oregon_sites <- sites %>%
  filter(latitude >= 42.6673) %>%
  pull(site)

kelp_OR <- kelp_adult %>% filter(site %in% oregon_sites)

# Step 3: Spatial variance workflow
kelp_var_site <- kelp_OR %>%
  group_by(site, year) %>%
  summarise(var_biomass = var(biomass, na.rm = TRUE), .groups = "drop")

mean_var_site <- kelp_var_site %>%
  group_by(site) %>%
  summarise(mean_var = mean(var_biomass, na.rm = TRUE), .groups = "drop")

overall_var <- mean(mean_var_site$mean_var, na.rm = TRUE)

overall_var # target number

```

#### BULL KELP RECRUITS

Here we use swath (KelpForest_Swath) data for bull kelp recruits assuming that kelp
on month "8" (August) are successfully settle recruits
```{r}
# Step 1: Filter for "Juv" Bull kelp, here we assume that kelp on month "8" are successful recruits 
kelp_recruits <- swath %>%
  filter(classcode == "NERLUE") %>%
  select(year, month, site, zone, transect, count) %>%
  group_by(year, month, site, zone, transect) %>%
  summarise(count = mean(count), .groups = "drop") %>%
  filter(site %in% oregon_sites, month == 8) # OR sites & month "8" August

#Step 2: Mean succesfull recruitment across space and time
recruit_mean <- kelp_recruits %>%
  group_by(year, site) %>%
  summarise(mean_count = mean(count), .groups = "drop")

#Step 3: Fit GLM to detrend site and year effects & Normalize and calculate sd (temporal noise)
model_rec <- glm(mean_count ~ year * site, data = recruit_mean)
ts_detrended <- mean(recruit_mean$mean_count) + residuals(model_rec)
noise_rec     <- sd(ts_detrended / mean(ts_detrended))

noise_rec # target number

```

#### URCHINS ADULTS

Pull out data for urchins
```{r}
# Step 1: Biomass constants (Ling et al. 2015)
red_bio <- 0.0499 * 7   + 0.0019
pur_bio <- 0.0499 * 4.1 + 0.0019

# Step 2: Aggregate counts per transect & compute biomass
urchin_OR <- swath %>%
  filter(classcode %in% c("MESFRAAD", "STRPURAD")) %>%
  select(year, site, zone, transect, classcode, count) %>%
  filter(site %in% oregon_sites) %>%
  group_by(year, site, zone, transect, classcode) %>%
  summarise(count = sum(count), .groups = "drop") %>%
  pivot_wider(names_from = classcode,
              values_from = count,
              values_fill = 0) %>%
  transmute(year, site, zone, transect,
            red_count    = MESFRAAD,
            purp_count   = STRPURAD,
            red_biomass  = red_count  * red_bio,
            purp_biomass = purp_count * pur_bio,
            total_biomass = red_biomass + purp_biomass)

# Step 3: Spatial variance in biomass
urchin_var <- urchin_OR %>%
  pivot_longer(cols = c(red_biomass, purp_biomass, total_biomass),
               names_to = "spp",
               values_to = "biomass") %>%
  group_by(year, site, zone, spp) %>%
  summarise(var = var(biomass, na.rm = TRUE), .groups = "drop")

# Step 4: Temporal and overall metrics
urchin_yearvar <- urchin_var %>%
  group_by(year, spp) %>%
  summarise(mean_var = mean(var, na.rm = TRUE), .groups = "drop") %>%
  group_by(spp) %>%
  summarise(year_var = mean(mean_var, na.rm = TRUE))

urchin_overall <- urchin_var %>%
  group_by(spp) %>%
  summarise(overall_var = mean(var, na.rm = TRUE))

urchin_yearvar
urchin_overall # target number

```

#### Urchin recruits

Pull out data for urchin recruits
```{r}
# Step 1: Filter for recruits (<2.5cm test diameter) of purple (STRPURREC) and red (MESFRAREC) urchins,
#    then aggregate counts within each transect.
urchin_rec <- swath %>%
  filter(classcode %in% c("MESFRAREC", "STRPURREC")) %>%
  select(year, site, zone, transect, count) %>%
  group_by(site, year, transect) %>%
  summarise(count_transect = sum(count), .groups = "drop")

# Step 2: Collapse to site–year totals
urchin_rec_sy <- urchin_rec %>% #site-year "sy"
  group_by(site, year) %>%
  summarise(count = sum(count_transect), .groups = "drop")

# Step 3: Fit a zero‑inflated Poisson with site and nested year random effects
brms_rec <- brm(formula = count ~ 1 + (1 | site / year), #count ~ site_code + (1 | site_code / year)
                family  = zero_inflated_poisson(),
                data    = urchin_rec_sy,
                iter    = 4000,
                warmup  = 1000,
                thin    = 3,
                chains  = 3,
                cores   = 3)

summary(brms_rec)
plot(brms_rec)

# Step 4: Extract posterior draws for the year‐within‐site sd parameter
post <- as_draws_df(brms_rec)

# Parameter name: sd_site:year__Intercept
log_sd_year <- post[["sd_site:year__Intercept"]]

# Step 5: Compute the mean of the posterior sd (the “temporal noise” estimate)
temporal_noise_urchin <- mean(log_sd_year)

temporal_noise_urchin # target number

```


<!-- ### Urchin-Kelp -->

<!-- Join tables -->
<!-- ```{r} -->
<!-- KelpUrchin_df <- Kelp_df %>%  -->
<!--   full_join(Urchins_df_OR, -->
<!--             by = c("year","site", "side", "zone", "transect", "site_status"))  -->

<!-- # replace NA with 0 -->
<!-- KelpUrchin_df <- KelpUrchin_df %>% replace(is.na(.), 0) -->

<!-- # set site status  -->
<!-- KelpUrchin_df <- KelpUrchin_df %>%  -->
<!--   mutate(site_status = as.factor(site_status)) -->

<!-- # remove sites with <3 years of data -->
<!--   # find sites with >3 years -->
<!--   site_keep <- KelpUrchin_df %>%  -->
<!--     select(site, year) %>%  -->
<!--     unique() %>%  -->
<!--     group_by(site) %>%  -->
<!--     filter(n()>2) %>% pull(site) -->

<!--   KelpUrchin_df <- KelpUrchin_df %>%  -->
<!--     filter(site %in% site_keep) -->


<!-- # calc stats at site level -->
<!-- KelpUrchin_df_site <- KelpUrchin_df %>%  -->
<!--   group_by(year, site, site_status) %>%  -->
<!--   summarise(across(Kelp_plants:Urchins_biomass, ~mean(., na.rm = T))) -->

<!-- # take log -->
<!-- KelpUrchin_df_site <- KelpUrchin_df_site %>%  -->
<!--   mutate(across(Kelp_plants:Urchins_biomass, ~log(.), .names = "{col}_ln")) -->



<!-- ``` -->


<!-- Transect scale -->

<!-- urchins v. kelp -->
<!-- ```{r} -->
<!-- # basic -->
<!-- ggplot(KelpUrchin_df) + -->
<!--   geom_point(aes(x = Urchins_biomass, y = Kelp_biomasswet), alpha = 0.3) + -->
<!--   ylab('Kelp (kg/60m2)') + xlab('Urchins (kg/60m2)') -->


<!-- # facet MPA status -->
<!-- ggplot(KelpUrchin_df, aes(x = Urchins_biomass, y = Kelp_biomasswet, color = site_status)) + -->
<!--   geom_point(alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1, scales = 'free') +  -->
<!--   geom_rug(linewidth=0.1) + -->
<!--   ylab('Kelp (kg/60m2)') + xlab('Urchins (kg/60m2)') -->

<!-- ggscatterhist( -->
<!--   KelpUrchin_df, x = "Urchins_biomass", y = "Kelp_biomasswet", -->
<!--   color = "site_status", fill = "site_status", -->
<!--   size = 3, alpha = 0.6, -->
<!--   margin.plot = "boxplot", -->
<!--   ggtheme = theme_bw()) -->



<!-- # facet site (+MPA status) -->
<!-- ggplot(KelpUrchin_df, aes(x = Urchins_biomass, y = Kelp_biomasswet, color = site_status)) + -->
<!--   geom_point(alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status, site)) +  -->
<!--   geom_rug(linewidth=0.1) + -->
<!--   ylab('Kelp (kg/60m2)') + xlab('Urchins (kg/60m2)') -->



<!-- # facet MPA status + colour urchin -->
<!-- ggplot(KelpUrchin_df) + -->
<!--   geom_point(aes(x = purple_biomass, y = Kelp_biomasswet), colour = "purple", alpha = 0.3) + -->
<!--   geom_point(aes(x = red_biomass, y = Kelp_biomasswet), colour = "red", alpha = 0.3) + -->
<!--     facet_wrap(vars(site_status), ncol = 1, scales = 'free') + -->
<!--   ylab('Kelp (kg/60m2)') + xlab('Urchins (kg/60m2)') -->


<!-- ggplot(KelpUrchin_df) + -->
<!--   geom_point(aes(x = purple_count, y = Kelp_stipes), colour = "purple", alpha = 0.3) + -->
<!--   geom_point(aes(x = red_count, y = Kelp_stipes), colour = "red", alpha = 0.3) + -->
<!--     facet_wrap(vars(site_status), ncol = 1, scales = 'free') + -->
<!--   ylab('Stipes (no./60m2)') + xlab('Urchins (no./60m2)') -->

<!-- ``` -->

<!-- urchins & kelp data distributions -->
<!-- ```{r} -->
<!-- g1 <- ggplot(KelpUrchin_df) + -->
<!--   stat_ecdf(aes(x = Kelp_biomasswet, colour = site_status),  -->
<!--             size = 1, pad = F) -->

<!-- g2 <- ggplot(KelpUrchin_df) + -->
<!--   stat_ecdf(aes(x = -Urchins_biomass, colour = site_status), -->
<!--             size = 1, pad = F) -->

<!-- ggarrange(g1, g2, ncol = 1) -->

<!-- ``` -->

<!-- urchins & kelp v. time -->
<!-- ```{r} -->
<!-- ggplot(KelpUrchin_df) + -->
<!--   geom_point(aes(y = Urchins_biomass, x = year), colour = "orange", alpha = 0.3) + -->
<!--   geom_point(aes(y = Kelp_biomasswet, x = year), colour = "darkgreen", alpha = 0.3)  -->

<!-- ggplot(KelpUrchin_df, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = Urchins_biomass), colour = "orange", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Urchins_biomass), colour = "orange", alpha = 0.3) + -->
<!--   geom_hline(yintercept = 204, linetype = "dashed", color = "grey80", size = 1) + # ling threshold upper -->
<!--   geom_hline(yintercept = 156, linetype = "dashed", color = "grey50", size = 1) + # ling threshold mean -->
<!--   geom_hline(yintercept = 108, linetype = "dashed", color = "grey80", size = 1) + # ling threshold lower -->
<!--   geom_vline(xintercept = 2014, linetype = "dashed", color = "red", size = 1) + # heatwave -->
<!--   geom_vline(xintercept = 2016, linetype = "dashed", color = "red", size = 1) + -->
<!--   facet_wrap(vars(site_status, site)) + -->
<!--   scale_y_continuous(name = "biomass (kg/60m2)", limit = c(0,1000)) + -->
<!--   theme_bw() -->

<!-- # Anacapa East over-time averages (first by year, than over) -->
<!-- KelpUrchin_df %>%  -->
<!--   filter(site == "ANACAPA_EAST_ISLE") %>%  -->
<!--   group_by(year) %>%  -->
<!--   summarise(across(Kelp_plants:Urchins_biomass, ~mean(.))) %>%  -->
<!--   summarise(across(Kelp_plants:Urchins_biomass, ~mean(.))) -->


<!-- ggplot(KelpUrchin_df, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = Urchins_count), colour = "orange", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Urchins_count), colour = "orange", alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status, site)) + -->
<!--   scale_y_continuous(name = "Abundance (no./60m2)") -->


<!-- ggplot(KelpUrchin_df) + -->
<!--   geom_point(aes(y = Kelp_biomasswet, x = year), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = purple_biomass, x = year), colour = "purple", alpha = 0.3) + -->
<!--   geom_point(aes(y = red_biomass, x = year), colour = "red", alpha = 0.3) +   -->
<!--   facet_wrap(~site) -->


<!-- ``` -->


<!-- Site scale -->
<!-- ```{r} -->
<!-- # mean and sd across sites -->
<!-- KelpUrchin_df_site %>% ungroup() %>%  -->
<!--   summarise(across(c(Kelp_biomasswet,Urchins_biomass), list(mean = mean, sd = sd))) -->

<!-- # mean and sd across forested sites only -->
<!-- KelpUrchin_df_site %>% ungroup() %>%  -->
<!--   filter(Kelp_biomasswet>0) %>%  -->
<!--   summarise(across(c(Kelp_biomasswet,Urchins_biomass), list(mean = mean, sd = sd))) -->

<!-- # mean and sd across sites by status -->
<!-- KelpUrchin_df_site %>% group_by(site_status) %>%  -->
<!--   summarise(across(c(Kelp_biomasswet,Urchins_biomass), list(mean = mean, sd = sd))) -->


<!-- ggscatterhist( -->
<!--   KelpUrchin_df_site, x = "Urchins_biomass", y = "Kelp_biomasswet", -->
<!--   color = "site_status", fill = "site_status", -->
<!--   size = 3, alpha = 0.6, -->
<!--   margin.plot = "boxplot", ggtheme = theme_bw(),  -->
<!--   xlab = 'Observed urchin biomass (kg.60m2)', ylab = 'Observed kelp biomass (kg.60m2)') -->


<!-- # (per m2) -->
<!--  KelpUrchin_df_site <- KelpUrchin_df_site %>%  -->
<!--             mutate(Urchins_biomass_m = Urchins_biomass/60,  -->
<!--                    Kelp_biomasswet_m = Kelp_biomasswet/60) -->
<!-- ggscatterhist( -->
<!--   KelpUrchin_df_site, x = "Urchins_biomass_m", y = "Kelp_biomasswet_m", -->
<!--   size = 3, alpha = 0.6, -->
<!--   margin.plot = "boxplot", -->
<!--   ggtheme = theme_bw()) -->



<!-- ggplot(KelpUrchin_df_site, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = Urchins_biomass), colour = "orange", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Urchins_biomass), colour = "orange", alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   geom_hline(yintercept = (2.6+0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold upper -->
<!--   geom_hline(yintercept = 2.6*60, linetype = "dashed", color = "grey50", size = 1) + # ling threshold mean -->
<!--   geom_hline(yintercept = (2.6-0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold lower   -->
<!--   geom_vline(xintercept = 2014, linetype = "dashed", color = "red", size = 1) + # heatwave -->
<!--   geom_vline(xintercept = 2016, linetype = "dashed", color = "red", size = 1) + -->
<!--   scale_y_continuous(name = "biomass (kg/60m2)") + -->
<!--   theme_bw() -->



<!-- KelpUrchin_df_sitemeanMPA <- KelpUrchin_df_site %>%  -->
<!--   group_by(site_status, year) %>%  -->
<!--   summarise(across(Kelp_plants:Urchins_biomass, ~mean(.)))  -->

<!-- ggplot(KelpUrchin_df_sitemeanMPA,aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_biomasswet), colour = "darkgreen", size = 2) + -->
<!--   geom_point(aes(y = Urchins_biomass), colour = "orange", size = 2) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   geom_hline(yintercept = (2.6+0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold upper -->
<!--   geom_hline(yintercept = 2.6*60, linetype = "dashed", color = "grey50", size = 1) + # ling threshold mean -->
<!--   geom_hline(yintercept = (2.6-0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold lower   -->
<!--   geom_vline(xintercept = 2014, linetype = "dashed", color = "red", size = 1) + # heatwave -->
<!--   geom_vline(xintercept = 2016, linetype = "dashed", color = "red", size = 1) + -->
<!--   scale_y_continuous(name = "biomass (kg/60m2)") + -->
<!--   theme_bw() -->

<!-- ggplot(KelpUrchin_df_sitemeanMPA) + -->
<!--   geom_point(aes(y = Kelp_biomasswet, x = Urchins_biomass, colour = site_status), size = 2) + -->
<!--   geom_point(data = KelpUrchin_df_site, aes(y = Kelp_biomasswet, x = Urchins_biomass, colour = site_status), alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   geom_vline(xintercept = (2.6+0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold upper -->
<!--   geom_vline(xintercept = 2.6*60, linetype = "dashed", color = "grey50", size = 1) + # ling threshold mean -->
<!--   geom_vline(xintercept = (2.6-0.8)*60, linetype = "dashed", color = "grey80", size = 1) + # ling threshold lower   -->
<!--   scale_y_continuous(name = "biomass (kg/60m2)") + -->
<!--   theme_bw() -->





<!-- ggplot(KelpUrchin_df_site, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_biomasswet), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = purple_biomass), colour = "purple", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = purple_biomass), colour = "purple", alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   scale_y_continuous(name = "biomass (kg/60m2)") + -->
<!--   theme_bw() -->



<!-- ggplot(KelpUrchin_df_site, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = Urchins_count), colour = "orange", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Urchins_count), colour = "orange", alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   scale_y_continuous(name = "density (no./60m2)",  limits = c(0,300)) + -->
<!--   theme_bw() -->


<!-- ggplot(KelpUrchin_df_site, aes(x = year)) + -->
<!--   geom_point(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = Kelp_stipes), colour = "darkgreen", alpha = 0.3) + -->
<!--   geom_point(aes(y = purple_count), colour = "purple", alpha = 0.3) + -->
<!--   geom_smooth(aes(y = purple_count), colour = "purple", alpha = 0.3) + -->
<!--   facet_wrap(vars(site_status), ncol = 1) + -->
<!--   scale_y_continuous(name = "density (no./60m2)",  limits = c(0,300)) + -->
<!--   theme_bw() -->

<!-- ``` -->
